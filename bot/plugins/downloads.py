from hydrogram import filters
from hydrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from secrets import token_hex
from bot import TelegramBot
from bot.config import Telegram
from bot.modules.decorators import verify_user
import subprocess
import os

DOWNLOAD_PATH = "downloads"  # Ù…Ø¬Ù„Ø¯ Ù„Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§
os.makedirs(DOWNLOAD_PATH, exist_ok=True)  # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§

@TelegramBot.on_message(filters.private & filters.text)
@verify_user
async def handle_video_link(_, msg: Message):
    video_url = msg.text.strip()

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­
    if not video_url.startswith(("http://", "https://")):
        return await msg.reply("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ØµØ§Ù„Ø­!")

    sender_id = msg.from_user.id
    secret_code = token_hex(8)  # Ø±Ù…Ø² Ø³Ø±ÙŠ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·
    output_filename = f"{secret_code}.mp4"
    output_path = os.path.join(DOWNLOAD_PATH, output_filename)

    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… yt-dlp
    waiting_msg = await msg.reply("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")

    try:
        subprocess.run(
            ["yt-dlp", "-o", output_path, "-f", "best", video_url],
            check=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )
    except subprocess.CalledProcessError as e:
        return await msg.reply(f"âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:\n{e.stderr}")

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    video_msg = await msg.reply_video(
        video=output_path,
        caption="âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:",
        reply_markup=InlineKeyboardMarkup(
            [
                [
                    InlineKeyboardButton("ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„", callback_data=f"reload_{secret_code}"),
                    InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", callback_data=f"delete_{secret_code}")
                ]
            ]
        )
    )

    # Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."
    await waiting_msg.delete()

    # Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    os.remove(output_path)
